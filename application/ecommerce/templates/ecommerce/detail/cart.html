{% extends "global/base.html" %}
{% load static %}

{% block content %}
<div class="cart-container">
    <h2>Seu Carrinho</h2>

    {% if request.session.cart %}
        {% for item in request.session.cart.values %}
            <div class="cart-item">
                <div class="cart-item-image">
                    <img src="{% get_media_prefix %}{{ item.imagem }}" alt="{{ item.product_name }}">
                </div>
                <div class="cart-item-details">
                    <h3 class="product-name">{{ item.product_name }}</h3>
                    {% if item.product_variation %}
                        <p class="variation">Variação: {{ item.product_variation }}</p>
                    {% endif %}
                    <p class="price">
                        {% if item.promotional_price %}
                            <span class="original-price">R$ {{ item.price }}</span>
                            <span class="promo-price">R$ {{ item.promotional_price }}</span>
                        {% else %}
                            <span class="normal-price">R$ {{ item.price }}</span>
                        {% endif %}
                    </p>

                    <div class="quantity-controls">
                        <form action="{% url "ecommerce:alter_product_unit_cart" %}" class="quantity-form">
                            <input type="hidden" name="variation_id" value="{{ item.product_variation_id }}">
                            <button type="submit" name="action" value="decrease" class="btn quantity-btn">-</button>
                            <span class="amount">{{ item.amount }}</span>
                            <button type="submit" name="action" value="increase" class="btn quantity-btn">+</button>
                        </form>
                    </div>

                    <div class="cart-actions">
                        <form action="{% url "ecommerce:alter_product_unit_cart" %}">
                            <input type="hidden" name="variation_id" value="{{ item.product_variation_id }}">
                            <button type="submit" class="btn remove-btn">Remover</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}

        <div class="cart-footer">
            <form action="#" method="get">
                <button type="submit" class="btn buy-now">Fechar Pedido</button>
            </form>
        </div>
    {% else %}
        <p>Seu carrinho está vazio.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('.quantity-form');

        function debounce(callback, delay) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => callback.apply(this, args), delay);
            };
        }

        forms.forEach((form) => {
            const decreaseBtn = form.querySelector('button[name="action"][value="decrease"]');
            const increaseBtn = form.querySelector('button[name="action"][value="increase"]');
            const variationInput = form.querySelector('input[name="variation_id"]');
            const actionInput = form.querySelector('input[name="action"]');

            const submitWithAction = (action) => {
                if (actionInput) {
                    actionInput.value = action;
                } else {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'action';
                    hidden.value = action;
                    form.appendChild(hidden);
                }
                form.submit();
            };

            const debouncedSubmit = debounce(submitWithAction, 300);

            increaseBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                debouncedSubmit('increase');
            });

            decreaseBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                debouncedSubmit('decrease');
            });
        });
    });
</script> 
{% endblock content %}
